---
- name: create namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: forgejo

- name: get crd info
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: servicemonitors.monitoring.coreos.com
  register: crd_info
  ignore_errors: true

- name: enable servicemonitors if crd exists
  ansible.builtin.set_fact:
    use_service_monitor: true
  when: "crd_info['resources'] | length > 0"

- name: get secret presence
  kubernetes.core.k8s_info:
    kind: Secret
    namespace: forgejo
    name: forgejo-pg-user
  register: secret_presence

- name: generate password and assign to variable
  ansible.builtin.set_fact:
    database_password: "{{ lookup('community.general.random_string', special=false, length=32) }}"
  no_log: true
  when: "not secret_presence['resources']"

- name: extract the secret if it's there
  ansible.builtin.set_fact:
    database_password: "{{ secret_presence['resources'][0]['data']['password'] | ansible.builtin.b64decode }}"
  no_log: true
  when: "secret_presence['resources'] | length > 0"

- name: create secret for pg user
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      data:
        username: Zm9yZ2Vqbw==
        password: "{{ database_password | ansible.builtin.b64encode }}"
      kind: Secret
      metadata:
        name: forgejo-pg-user
        namespace: forgejo
      type: kubernetes.io/basic-auth
  when: "not secret_presence['resources']"

- name: create database
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: postgresql.cnpg.io/v1
      kind: Cluster
      metadata:
        name: forgejodb
        namespace: forgejo
      spec:
        instances: 3
        storage:
          size: 8Gi
          storageClass: longhorn
        bootstrap:
          initdb:
            database: forgejo
            owner: forgejo
            secret:
              name: forgejo-pg-user

- name: db podmonitor
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: PodMonitor
      metadata:
        name: cluster-monitor-forgejo
        namespace: forgejo
      spec:
        selector:
          matchLabels:
            cnpg.io/cluster: forgejodb
        podMetricsEndpoints:
          - port: metrics
  when: "crd_info['resources'] | length > 0"

- name: install forgejo
  kubernetes.core.helm:
    name: forgejo
    chart_ref: oci://code.forgejo.org/forgejo-helm/forgejo
    namespace: forgejo
    create_namespace: true
    values:
      global:
        storageClass: longhorn
      clusterDomain: "{{ k8s_svc_dns }}"
      securityContext:
        capabilities:
          add: ["SYS_CHROOT"]
      gitea:
        metrics:
          enabled: true
        config:
          server:
            ROOT_URL: "https://git.{{ dns_domain_name }}/"
            DOMAIN: "git.{{ dns_domain_name }}"
            SSH_DOMAIN: "git.{{ dns_domain_name }}"
            ENABLE_PPROF: true
          database:
            DB_TYPE: postgres
            HOST: "forgejodb-rw:5432"
            USER: forgejo
            PASSWD: "{{ database_password }}"
            NAME: forgejo
      persistence:
        size: "{{ forgejo_volume_size }}"

- name: service monitor
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: monitoring.coreos.com/v1
      kind: ServiceMonitor
      metadata:
        name: forgejo-prometheus-servicemonitor
        namespace: forgejo
        labels:
          name: forgejo-prometheus-servicemonitor
      spec:
        selector:
          matchLabels:
            app: forgejo
        endpoints:
          - port: http
  when: "crd_info['resources'] | length > 0"

- name: forgejo certificate
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: cert-manager.io/v1
      kind: Certificate
      metadata:
        name: forgejo-certificate
        namespace: forgejo
      spec:
        dnsNames:
          - "git.{{ dns_domain_name }}"
        secretName: forgejo-certificate
        issuerRef:
          name: letsencrypt-dns01-issuer
          kind: ClusterIssuer

- name: forgejo gateway
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: Gateway
      metadata:
        name: forgejo-gateway
        namespace: forgejo
      spec:
        gatewayClassName: istio
        listeners:
          - name: http
            port: 443
            protocol: HTTPS
            allowedRoutes:
              namespaces:
                from: Same
            tls:
              certificateRefs:
                - kind: Secret
                  group: ""
                  name: forgejo-certificate
          - name: ssh
            port: 22
            protocol: TCP
            allowedRoutes:
              namespaces:
                from: Same

- name: forgejo tcproute
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1alpha2
      kind: TCPRoute
      metadata:
        name: forgejo-ssh-route
        namespace: forgejo
      spec:
        parentRefs:
          - name: forgejo-gateway
            sectionName: ssh
        hostnames:
          - "git.{{ dns_domain_name }}"
        rules:
          - backendRefs:
              - name: forgejo-ssh
                port: 22

- name: forgejo httproute
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: gateway.networking.k8s.io/v1
      kind: HTTPRoute
      metadata:
        name: forgejo-http-route
        namespace: forgejo
      spec:
        parentRefs:
          - name: forgejo-gateway
            sectionName: http
        hostnames:
          - "git.{{ dns_domain_name }}"
        rules:
          - backendRefs:
              - name: forgejo-http
                port: 3000
